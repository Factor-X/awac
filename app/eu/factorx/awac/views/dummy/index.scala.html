<!doctype html>
<html ng-app="app">
    <head>

        <script src='@routes.Assets.at("javascripts/angular-1.2.17/angular.min.js")'></script>
        <script src='@routes.Assets.at("javascripts/angular-1.2.17/angular-animate.min.js")'></script>

        <script>

            var app = angular.module('app', ['ngAnimate']);

            // ctrl
            app.controller('MainCtrl', function ($scope) {
                $scope.isLoading = function () {
                    for (var k in $scope.initialLoad) {
                        if (!$scope.initialLoad[k]) return true;
                    }
                    return false;
                };

                $scope.initialLoad = {
                    translations: false
                };

                $scope.$on('LOAD_FINISHED', function (event, args) {
                    if (args.type == 'TRANSLATIONS') {
                        $scope.initialLoad.translations = args.success;
                    }
                });


            });

            // simple download service
            app.service('downloadService', function ($http) {

                this.downloadsInProgress = 0;

                this.getDownloadsInProgress = function () {
                    return this.downloadsInProgress;
                };

                this.getJson = function (url, callback) {

                    this.downloadsInProgress++;

                    var promise = $http({
                        method: 'GET',
                        url: url,
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    promise.success(function (data, status, headers, config) {
                        this.downloadsInProgress--;
                        callback(data, status, headers, config);
                    });
                    promise.error(function (data, status, headers, config) {
                        this.downloadsInProgress--;
                        callback(null, status, headers, config);
                        console.log("error when loading to " + property)
                    });
                    return promise;

                };
            });

            // i18n
            app.service('translationService', function ($http, $rootScope, downloadService) {

                var svc = this;
                svc.elements = null;
                downloadService.getJson("/awac/translations/fr", function (data) {
                    svc.elements = data.lines;
                    $rootScope.$broadcast('LOAD_FINISHED', { type: 'TRANSLATIONS', success: data != null });
                });
                svc.get = function (code) {
                    if (svc.elements == null) return '';
                    return svc.elements[code];
                }
            });

            app.filter("translate", function ($sce, translationService) {
                return function (input) {

                    var text = translationService.get(input);

                    if (text != null) {
                        return  $sce.trustAsHtml("<span class=\"translated-text\" data-code=\"" + input + "\">" + text + "</span>");
                    } else {
                        return  $sce.trustAsHtml("<span class=\"translated-text translation-missing\" data-code=\"" + input + "\">[" + input + "]</span>");
                    }
                };
            });


        </script>


        <style>
            .translated-text {
            }

            .translated-text.translation-missing {
                font-style: italic;
                color: red;
            }

            .loading-overlay {
                position: absolute;
                left: 0;
                right: 0;
                top: 0;
                bottom: 0;
                background: #eee;
                color: #333;

                text-align: center;
                padding-top: 50%;
            }

            .fadeout {
                -webkit-transition: all cubic-bezier(0.250, 0.460, 0.450, 0.940) 1.5s;
                -moz-transition: all cubic-bezier(0.250, 0.460, 0.450, 0.940) 1.5s;
                -o-transition: all cubic-bezier(0.250, 0.460, 0.450, 0.940) 1.5s;
                transition: all cubic-bezier(0.250, 0.460, 0.450, 0.940) 1.5s;
            }

            .fadeout.ng-hide-add.ng-hide-add-active {
                opacity: 0;
                display: block !important;
            }

            .fadeout.ng-hide-add {
                opacity: 1;
                display: block !important;
            }
        </style>
    </head>
    <body ng-controller="MainCtrl">

        @loadingScreen()

        <div ng-show="!isLoading()">

            <h1>Test of translation</h1>

            <b>Good Translated text:</b> @t("ABCD")

            <hr/>

            <b>Bad Translated text:</b> @t("ABCD-EFGH")
        </div>
    </body>
</html>



